#!/bin/bash
  if [ -e librelogo ] 
  then
	# for correct file install into package dir
        [ -e "$PREFIX/bin/libreoffice" ] && echo "$PREFIX/bin/libreoffice exists, skip build libreoffice" && exit 0
	install -d src
	LIBREOFFICE=`basename $PWD|cut -d'-' -f2`
	LIBREOFFICE_SHORT=`echo $LIBREOFFICE |cut -d'.' -f1,2,3`
	echo "LIBREOFFICE : $LIBREOFFICE, LIBREOFFICE_SHORT : $LIBREOFFICE_SHORT"
	for PACK in translations help
	do
        [ ! -e src/libreoffice-$PACK-$LIBREOFFICE.tar.xz ] && wget http://download.documentfoundation.org/libreoffice/src/$LIBREOFFICE_SHORT/libreoffice-$PACK-$LIBREOFFICE.tar.xz && mv libreoffice-$PACK-$LIBREOFFICE.tar.xz src && cd .. && tar xJvf libreoffice-$LIBREOFFICE/src/libreoffice-$PACK-$LIBREOFFICE.tar.xz && cd libreoffice-$LIBREOFFICE
	[ ! -e src/libreoffice-$PACK-$LIBREOFFICE.tar.xz ] && exit 1
	done
	export ACLOCAL="aclocal" 
	export ACLOCAL_FLAGS="-I/$PREFIX/share/aclocal -I$HOME/$ARCH/share/aclocal" 
	install -d $HOME/ydfs/src/libreoffice-$LIBREOFFICE/libreoffice-translations-$LIBREOFFICE
	export CXXFLAGS=$CFLAGS CC=clang CXX=clang++
	CONFIGURE_OPTS=""
	env > env.log
        [ "$ARCH" = "x86" ] && CONFIGURE_OPTS=" --host=i586-linux-gnu"
        # don't run broken tests
	sed -i "/CppunitTest_sw_ooxmlexport9/d" sw/Module_sw.mk
	sed -i "/CppunitTest_sw_uiwriter/d" sw/Module_sw.mk
	sed -i "/CppunitTest_sw_ww8export2/d" sw/Module_sw.mk 
	sed -i "/CppunitTest_xmlsecurity_signing/d" xmlsecurity/Module_xmlsecurity.mk
	sed -i "/CppunitTest_sc_subsequent_filters_test/d" sc/Module_sc.mk 
	sed -i "/CppunitTest_sc_subsequent_export_test/d" sc/Module_sc.mk
	sed -i "/CppunitTest_chart2_export/d" chart2/Module_chart2.mk
	sed -i "/CppunitTest_dbaccess_RowSetClones/d" dbaccess/Module_dbaccess.mk
	sed -i "/CppunitTest_dbaccess_hsqldb/d" dbaccess/Module_dbaccess.mk

	PYTHON_CFLAGS="-I$HOME/$ARCH/include/python2.7/" PYTHON_LIBS="-lpython2.7 -L$HOME/$ARCH/lib" \
	CPPFLAGS+=' -DU_USING_ICU_NAMESPACE=1'

	_additional_source_url="http://dev-www.libreoffice.org/src"
	_additional_source_url2="http://dev-www.libreoffice.org/extern"
	install -d tar
for TAR in ${_additional_source_url}/boost_1_65_1.tar.bz2 ${_additional_source_url}/35c94d2df8893241173de1d16b6034c0-swingExSrc.zip ${_additional_source_url}/798b2ffdc8bcfe7bca2cf92b62caf685-rhino1_5R5.zip ${_additional_source_url}/a7983f859eafb2677d7ff386a023bc40-xsltml_2.1.2.zip ${_additional_source_url}/0168229624cfac409e766913506961a8-ucpp-1.3.2.tar.gz ${_additional_source_url}/language-subtag-registry-2017-08-15.tar.bz2 ${_additional_source_url}/17410483b5b5f267aa18b7e00b65e6e0-hsqldb_1_8_0.zip ${_additional_source_url}/d8bd5eed178db6e2b18eeed243f85aa8-flute-1.1.6.zip ${_additional_source_url}/ba2930200c9f019c2d93a8c88c651a0f-flow-engine-0.9.4.zip ${_additional_source_url}/Firebird-3.0.0.32483-0.tar.bz2 ${_additional_source_url}/pdfium-3235.tar.bz2 ${_additional_source_url2}/8249374c274932a21846fa7629c2aa9b-officeotron-0.7.4-master.jar  ${_additional_source_url2}/odfvalidator-1.2.0-incubating-SNAPSHOT-jar-with-dependencies+ODFTOOLKIT-460+ODFTOOLKIT-475.jar ${_additional_source_url2}/185d60944ea767075d27247c3162b3bc-unowinreg.dll
do
  NAME=`basename $TAR`
  [ ! -e tar/$NAME ] && wget $TAR -O tar/$NAME
done

	./autogen.sh --with-build-version="${pkgver}-${pkgrel}" \
		--with-vendor="YourDistroFromScratch" \
		--enable-split-app-modules \
		--with-parallelism=${_MAKEFLAGS/-j/} \
		--disable-fetch-external \
		--with-external-tar=$PWD/tar \
		--enable-release-build \
		--prefix=$PREFIX --exec-prefix=$PREFIX --sysconfdir=$HOME/$ARCH/etc \
		--libdir=$PREFIX/lib --mandir=$PREFIX/share/man \
		--with-lang="" \
		--with-help \
		--disable-avahi \
		--enable-dbus \
		--enable-evolution2\
		--enable-gio\
		--disable-kde4\
		--enable-gtk3 \
		--enable-introspection \
		--disable-gstreamer-0-10 \
		--enable-openssl \
		--enable-odk\
		--enable-python=system \
		--enable-scripting-beanshell \
		--enable-scripting-javascript \
		--disable-dconf \
		--disable-report-builder \
		--enable-ext-wiki-publisher \
		--enable-ext-nlpsolver \
		--without-fonts\
		--with-system-apr \
		--with-system-libcdr \
		--with-system-mdds\
		--without-myspell-dicts \
		--with-system-libvisio \
		--with-system-libcmis \
		--with-system-libmspub \
		--with-system-libexttextcat \
		--with-system-orcus \
		--with-system-liblangtag \
		--with-system-libmwaw \
		--with-system-libodfgen \
		--with-system-libetonyek \
		--with-system-libfreehand \
		--without-system-firebird \
		--with-system-libtommath \
		--with-system-libatomic-ops \
		--with-system-libebook \
		--with-system-libabw \
		--with-system-coinmp \
		--with-system-dicts \
		--with-external-dict-dir=$HOME/$ARCH/share/hunspell \
		--with-external-hyph-dir=$HOME/$ARCH/share/hyphen \
		--with-external-thes-dir=$HOME/$ARCH/share/mythes \
		--with-system-beanshell \
		--with-system-cppunit\
		--with-system-graphite\
		--with-system-glm \
		--with-system-libwpg \
		--with-system-libwps \
		--with-system-redland\
		--with-system-libzmf \
		--with-system-gpgmepp \
		--with-system-libstaroffice \
		--with-system-serf \
		--without-system-boost\
		--with-system-icu \
		--with-system-cairo \
		--with-system-libs \
		--with-system-mythes \
		--with-system-headers \
		--without-system-hsqldb \
		--with-alloc=system \
		--with-system-clucene \
		--disable-dependency-tracking

	echo "Run make build"
	make build || exit $?
	make DESTDIR=${srcdir}/fakeinstall distro-pack-install || exit $?

install -d $PREFIX/share/pixmaps 
install -d $PREFIX/share/applications
for i in writer base calc draw impress math startcenter
do
  ln -svf $PREFIX/share/icons/hicolor/32x32/apps/libreoffice-$i.png \
          $PREFIX/share/pixmaps/
  mv $PREFIX/lib/libreoffice/share/xdg/$i.desktop $PREFIX/share/applications
done
unset i

        touch buildok-$ARCH
	exit 0
  fi
